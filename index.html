import re
import json
from collections import defaultdict, Counter
import plotly.graph_objects as go

def clean_text(text):
    text = re.sub(r'\(.*?\)|\[.*?\]|\{.*?\}', '', text)
    text = text.strip().lower()
    replacements = {
        r'retrieval[- ]?augmented generation': 'RAG',
        r'visual question answering|visual qa': 'VQA',
        r'question answering': 'QA',
        r'artificial intelligence|ai-based|ai system|ai model': 'AI',
        r'machine learning|ml': 'ML',
        r'large language model|large-scale language model|llm': 'LLM',
        r'benchmark': 'benchmarks',
    }
    for pattern, replacement in replacements.items():
        text = re.sub(pattern, replacement, text)
    meaningless_keywords = {
        'nlp', 'nlu', 'llm', 'natural language process', 'natural language processing',
        'large lanuage model', 'natural language', 'natural language generation',
        'language models', 'language model', 'llms', 'prompt engineering',
        'prompting', 'pre-trained language models', 'pre-trained language model',
        'gpt-4'
    }
    tokens = [token.strip() for token in text.split(',')]
    tokens = [token for token in tokens if token.lower() not in meaningless_keywords]
    return ', '.join(tokens)

def generate_ngrams(words, n):
    return [' '.join(words[i:i+n]) for i in range(len(words)-n+1)]

def extract_ngrams_with_titles(dict_list, keys, max_n=3, min_count=2):
    ngram_to_titles = defaultdict(set)

    for d in dict_list:
        title = d.get('Title', 'No Title')
        for key in keys:
            if key in d and isinstance(d[key], str):
                cleaned = clean_text(d[key])
                tokens = [token.strip() for token in cleaned.split(',') if token.strip()]
                for n in range(1, max_n + 1):
                    for ngram in generate_ngrams(tokens, n):
                        ngram_to_titles[ngram].add(title)

    filtered_ngrams = {
        ngram: len(titles) for ngram, titles in ngram_to_titles.items() if len(titles) >= min_count
    }

    return filtered_ngrams, {k: list(v) for k, v in ngram_to_titles.items()}

def shorten_label(label):
    label = label.replace('retrieval augmented generation', 'RAG')
    label = label.replace('artificial intelligence', 'AI')
    label = label.replace('machine learning', 'ML')
    label = label.replace('large language model', 'LLM')
    return label

def capitalize_label(label):
    exceptions = {'RAG', 'VQA', 'QA', 'AI', 'ML', 'LLM'}
    return ' '.join([word if word in exceptions else word.capitalize() for word in label.split()])

def plot_ngrams_with_titles(ngram_counts, ngram_to_titles, title='EMNLP2024 Keyword'):
    sorted_items = sorted(ngram_counts.items(), key=lambda x: x[1], reverse=True)

    label_group = defaultdict(list)
    count_group = defaultdict(int)

    for raw_label, count in sorted_items:
        shortened = shorten_label(raw_label)
        display_label = capitalize_label(shortened)
        label_group[display_label].append(raw_label)
        count_group[display_label] += count

    display_items = sorted(count_group.items(), key=lambda x: x[1], reverse=True)
    display_labels = [label for label, _ in display_items]
    counts = [count_group[label] for label in display_labels]

    hover_texts = []
    for display_label in display_labels:
        titles = set()
        for raw in label_group[display_label]:
            titles.update(ngram_to_titles[raw])
        titles = list(titles)
        hover = f"<b>{display_label}</b><br>" + "<br>".join(titles[:10])
        if len(titles) > 10:
            hover += f"<br>... and {len(titles) - 10} more"
        hover_texts.append(hover)

    fig = go.Figure(data=[
        go.Bar(
            x=display_labels,
            y=counts,
            text=hover_texts,
            hoverinfo='text',
            marker=dict(line=dict(width=0)),
            textposition='none',
        )
    ])

    fig.update_layout(
        title=title,
        yaxis_title="Number of papers",
        xaxis=dict(
            tickmode='linear',
            tickangle=-60,
            tickfont=dict(size=12)
        ),
        height=700,
        width=3200,
        bargap=0.25,
        margin=dict(l=50, r=50, t=80, b=300),
        font=dict(size=14),
    )

    fig_html = fig.to_html(include_plotlyjs='cdn', full_html=False)

    ngram_json = {}
    for display, raw_list in label_group.items():
        all_title_addr = set()
        for raw in raw_list:
            for title in ngram_to_titles[raw]:
                for paper in summaries:
                    if paper.get("Title") == title:
                        addr = paper.get("address", "No Address")
                        all_title_addr.add((title, addr))
                        break
        sorted_title_addr = sorted(all_title_addr, key=lambda x: x[1])
        ngram_json[display] = [{"title": t, "address": a} for t, a in sorted_title_addr]

    js_script = f"""
    <script>
    const ngramMap = {json.dumps(ngram_json)};
    window.addEventListener('DOMContentLoaded', () => {{
        const plotDiv = document.querySelector(".plotly-graph-div");

        const titleBox = document.createElement("div");
        titleBox.id = "titleBox";
        titleBox.style.width = "90%";
        titleBox.style.maxHeight = "300px";
        titleBox.style.minHeight = "250px";
        titleBox.style.margin = "20px auto";
        titleBox.style.border = "1px solid gray";
        titleBox.style.overflowY = "scroll";
        titleBox.style.padding = "10px";
        titleBox.style.fontSize = "16px";
        titleBox.innerHTML = "Click the Bars! You can see papers of the specific keyword";
        document.body.appendChild(titleBox);

        const tagContainer = document.createElement("div");
        tagContainer.id = "tagContainer";
        tagContainer.style.width = "90%";
        tagContainer.style.margin = "0 auto 10px auto";
        tagContainer.style.display = "flex";
        tagContainer.style.flexWrap = "wrap";
        document.body.insertBefore(tagContainer, titleBox);

        const searchBox = document.createElement("input");
        searchBox.id = "searchBox";
        searchBox.type = "text";
        searchBox.placeholder = "Search title or address...";
        searchBox.style.width = "90%";
        searchBox.style.margin = "10px auto";
        searchBox.style.display = "block";
        searchBox.style.padding = "10px";
        searchBox.style.fontSize = "16px";
        document.body.insertBefore(searchBox, tagContainer);

        let selectedLabels = [];

        function createTag(label) {{
            const tag = document.createElement("div");
            tag.className = "tag";
            tag.style.border = "1px solid #888";
            tag.style.borderRadius = "15px";
            tag.style.padding = "5px 10px";
            tag.style.margin = "5px";
            tag.style.backgroundColor = "#f0f0f0";
            tag.style.display = "flex";
            tag.style.alignItems = "center";
            tag.style.fontSize = "14px";

            const text = document.createElement("span");
            text.innerText = label;

            const close = document.createElement("span");
            close.innerText = " ✕";
            close.style.marginLeft = "8px";
            close.style.cursor = "pointer";
            close.onclick = () => {{
                selectedLabels = selectedLabels.filter(l => l !== label);
                renderTags();
                renderTitles();
            }};

            tag.appendChild(text);
            tag.appendChild(close);
            tagContainer.appendChild(tag);
        }}

        function renderTags() {{
            tagContainer.innerHTML = "";
            selectedLabels.forEach(createTag);
        }}

        function renderTitles() {{
            const keyword = searchBox.value.trim().toLowerCase();
            let filteredTitles = [];

            if (selectedLabels.length === 0) {{
                titleBox.innerHTML = "<i>Select a bar to see associated papers.</i>";
                return;
            }}

            let sets = selectedLabels.map(label => new Set(ngramMap[label].map(obj => JSON.stringify(obj))));
            let intersection = sets.reduce((a, b) => new Set([...a].filter(x => b.has(x))));
            filteredTitles = Array.from(intersection).map(x => JSON.parse(x));

            if (keyword) {{
                filteredTitles = filteredTitles.filter(obj =>
                    obj.title.toLowerCase().includes(keyword) || obj.address.toLowerCase().includes(keyword)
                );
            }}

            let content = `<b style='font-size:18px;'>${{selectedLabels.join(" + ")}}</b><br><br>`;
            filteredTitles.forEach((obj, i) => {{
                content += `${{i+1}}. <b>${{obj.title}}</b><br><span style='color:gray;'>${{obj.address}}</span><br><br>`;
            }});

            if (filteredTitles.length === 0) {{
                content += "<i>No matching results.</i>";
            }}

            titleBox.innerHTML = content;
        }}

        searchBox.addEventListener("input", renderTitles);

        plotDiv.on('plotly_click', function(data) {{
            const clickedLabel = data.points[0].x;
            if (!selectedLabels.includes(clickedLabel)) {{
                selectedLabels.push(clickedLabel);
                renderTags();
                renderTitles();
            }}
        }});
    }});
    </script>
    """

    with open("index.html", "w", encoding="utf-8") as f:
        f.write("<html><head><meta charset='utf-8'><title>Keyword Plot</title></head><body>")
        f.write(fig_html)
        f.write(js_script)
        f.write("</body></html>")

    print("✅ 'index.html' 생성 완료. 브라우저에서 열어보세요!")

# 실행 예시
summaries = []
seen_titles = set()

with open("/home/js/analysis_tool/EMNLP_Papers.json") as f:
    for line in f:
        paper = json.loads(line.strip())
        title = paper.get("Title")
        if title and title not in seen_titles:
            seen_titles.add(title)
            summaries.append(paper)

ngram_counts, ngram_to_titles = extract_ngrams_with_titles(
    summaries, keys=['Task', 'Keyword'], max_n=5, min_count=13
)
plot_ngrams_with_titles(ngram_counts, ngram_to_titles)
